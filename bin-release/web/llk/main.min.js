var BG=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.init,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.init=function(t){this.bg=Tools.createBitmapByName("bg"),this.bg.cacheAsBitmap=!0,this.bg.width=Tools.sw(),this.bg.height=Tools.sh(),this.addChild(this.bg),console.log(this.bg.x,this.bg.y,this.bg.width,this.bg.height)},e}(egret.Sprite);egret.registerClass(BG,"BG");var BlockBG=function(t){function e(){t.call(this),this.init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.init=function(){this.lifeBar=new LifeBar,this.lifeBar.x=100,this.lifeBar.y=-60,this.addChild(Tools.createBitmapByName("ceil")),this.blockpack=new BlockPack,this.blockpack.x=170,this.blockpack.y=150,this.addChild(this.blockpack),this.addChild(this.lifeBar)},e}(egret.Sprite);egret.registerClass(BlockBG,"BlockBG");var BlockPack=function(t){function e(){t.call(this),this.ceilW=4,this.ceilH=6,this.typeN=8,this.dataArr=[],this.mapData=[],this.dicObj={},this.addEventListener(egret.Event.ADDED_TO_STAGE,this.init,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.init=function(t){Tools.getInstance().addEventListener(ToolEvent.GAME_REFRESH,this.refreshMap,this),this.connectLine=new egret.Sprite,this.addChild(this.connectLine);for(var e=0;e<this.ceilW*this.ceilH/2;e++){var i=Math.floor(Math.random()*this.typeN);this.dataArr.push(i),this.dataArr.push(i)}this.dataArr=this.randomArr(this.dataArr);for(var n=0;n<this.ceilH+2;n++){this.mapData[n]=[];for(var s=0;s<this.ceilW+2;s++)this.mapData[n].push(0)}for(n=1;n<this.ceilH+1;n++)for(s=1;s<this.ceilW+1;s++){this.mapData[n][s]=1;var r=new BlockUI(this.dataArr[this.ceilW*(n-1)+(s-1)]);r.data=n+"_"+s,r.pos.x=n,r.pos.y=s,r.x=100*(s-1),r.y=100*(n-1),r.setAddChild(this),this.dicObj[n+"_"+s]=r}Tools.getInstance().addEventListener(ToolEvent.GAME_TAB_PATTERN,this.handleCore,this)},p.randomArr=function(t){for(var e=t,i=e.length;i>-1;)e.push(e.splice(Math.floor(Math.random()*i),1)[0]),i--;return e},p.handleCore=function(){var t=Tools.getInstance().lastPattern,e=Tools.getInstance().thisPattern;return t?e.type!=t.type?(t.removeChild(t.strokeSP),void(t=null)):void(this.checkLink(t.pos,e.pos)?this.clearBlockUI():(t.removeChild(t.strokeSP),t=null)):void 0},p.checkLink=function(t,e){return t.x==e.x&&this.leftAndRight(t,e)?(this.drawConnectLine(t,e,null,null),!0):t.y==e.y&&this.upAndDown(t,e)?(this.drawConnectLine(t,e,null,null),!0):this.oneCorner(t,e)?!0:this.twoCorner(t,e)},p.leftAndRight=function(t,e){if(t.x==e.x&&t.y==e.y)return!1;for(var i=t.y<e.y?t.y:e.y,n=t.y<e.y?e.y:t.y,s=i+1;n>s;s++)if(0!=this.mapData[t.x][s])return!1;return!0},p.upAndDown=function(t,e){if(t.x==e.x&&t.y==e.y)return!1;for(var i=t.x<e.x?t.x:e.x,n=t.x<e.x?e.x:t.x,s=i+1;n>s;s++)if(0!=this.mapData[s][t.y])return!1;return!0},p.oneCorner=function(t,e){var i=new egret.Point(e.x,t.y),n=new egret.Point(t.x,e.y);if(0==this.mapData[i.x][i.y]){var s=this.leftAndRight(e,i)&&this.upAndDown(t,i);if(s)return this.drawConnectLine(t,i,e,null),s}if(0==this.mapData[n.x][n.y]){var r=this.leftAndRight(t,n)&&this.upAndDown(e,n);return r&&this.drawConnectLine(t,n,e,null),r}return!1},p.twoCorner=function(t,e){var i,n=this.scan(t,e),s=[],r=[],o=0;if(0==n.length)return!1;for(var a=0;a<n.length;a++)i=n[a],1==i.direct?this.leftAndRight(t,i.a)&&this.leftAndRight(e,i.b)&&s.push(i):0==i.direct&&this.upAndDown(t,i.a)&&this.upAndDown(e,i.b)&&s.push(i);if(s.length>0){for(var h=0;h<s.length;h++)i=s[h],r.push(this.getLevel(t,i.a,i.b,e));for(var c=0;c<r.length;c++)r[c]<r[o]&&(o=c);return console.log(r,o),i=s[o],this.drawConnectLine(t,i.a,i.b,e),!0}return!1},p.scan=function(t,e){for(var i=[],n=0;n<this.ceilH+2;n++)0==this.mapData[n][t.y]&&0==this.mapData[n][e.y]&&this.leftAndRight(new egret.Point(n,t.y),new egret.Point(n,e.y))&&i.push(new Line(new egret.Point(n,t.y),new egret.Point(n,e.y),0));for(var s=0;s<this.ceilW+2;s++)0==this.mapData[t.x][s]&&0==this.mapData[e.x][s]&&this.upAndDown(new egret.Point(t.x,s),new egret.Point(e.x,s))&&i.push(new Line(new egret.Point(t.x,s),new egret.Point(e.x,s),1));return i},p.clearBlockUI=function(){var t=Tools.getInstance().lastPattern,e=Tools.getInstance().thisPattern;this.mapData[t.pos.x][t.pos.y]=0,this.mapData[e.pos.x][e.pos.y]=0,this.dicObj[t.pos.x+"_"+t.pos.y]=null,this.dicObj[e.pos.x+"_"+e.pos.y]=null,this.removeChild(t),this.removeChild(e),Tools.getInstance().lastPattern=null,Tools.getInstance().thisPattern=null},p.drawConnectLine=function(t,e,i,n){var s=100;this.connectLine.alpha=1,this.connectLine.graphics.clear(),this.connectLine.graphics.lineStyle(4,0),null!=n&&(this.connectLine.graphics.moveTo((n.y-1)*s,(n.x-1)*s),this.connectLine.graphics.lineTo((i.y-1)*s,(i.x-1)*s)),null!=i&&(this.connectLine.graphics.moveTo((i.y-1)*s,(i.x-1)*s),this.connectLine.graphics.lineTo((e.y-1)*s,(e.x-1)*s)),this.connectLine.graphics.moveTo((e.y-1)*s,(e.x-1)*s),this.connectLine.graphics.lineTo((t.y-1)*s,(t.x-1)*s);var r=egret.Tween.get(this.connectLine);r.to({alpha:0},300),Tools.getInstance().objLen-=2,0==Tools.getInstance().objLen&&(Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_OVER)),PopPanel.getInstance().tip("游戏结束，即将跳入结果页!",this.stage))},p.refreshMap=function(t){var e=[];for(var i in this.dicObj)e.push(this.dicObj[i]);e=this.randomArr(e),this.dicObj={};for(var n=0;n<e.length;n++){var s=Math.floor(n/this.ceilW),r=Math.floor(n%this.ceilW);null!=e[n]?(e[n].x=100*r,e[n].y=100*s,e[n].pos.x=s+1,e[n].pos.y=r+1,this.dicObj[s+1+"_"+(r+1)]=e[n],this.mapData[s+1][r+1]=1):(this.dicObj[s+1+"_"+(r+1)]=null,this.mapData[s+1][r+1]=0)}},p.getLevel=function(t,e,i,n){var s=t.x==e.x?Math.abs(t.y-e.y):Math.abs(t.x-e.x),r=e.x==i.x?Math.abs(e.y-i.y):Math.abs(e.x-i.x),o=n.x==i.x?Math.abs(n.y-i.y):Math.abs(n.x-i.x);return s+r+o},e}(egret.Sprite);egret.registerClass(BlockPack,"BlockPack");var BlockUI=function(t){function e(e){t.call(this),this.colArr=[16711680,16515327,3539199,52479,65448,65298,13041408,16756224],this.pos=new egret.Point,this.ifHide=!0,this.type=e}__extends(e,t);var i=(__define,e);return p=i.prototype,p.setAddChild=function(t){t.addChild(this),this.init(),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.dispose,this)},p.init=function(){this.createBG(),this.touchEnabled=!0,this.addEventListener(egret.TouchEvent.TOUCH_TAP,this.selectPattern,this),Tools.getInstance().addEventListener(ToolEvent.GAME_OVER,this.gameOver,this)},p.selectPattern=function(t){this.ifHide&&(this.strokeSP?this.addChild(this.strokeSP):this.createStroke(),Tools.getInstance().lastPattern=Tools.getInstance().thisPattern,Tools.getInstance().thisPattern=this,Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_TAB_PATTERN)))},p.dispose=function(){this.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.selectPattern,this)},p.createStroke=function(){var t=new egret.Sprite;t.graphics.lineStyle(4,4743168),t.graphics.drawCircle(0,0,40),this.strokeSP=t,this.strokeSP.addEventListener(egret.Event.ADDED_TO_STAGE,this.setHide1,this),this.strokeSP.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.setHide2,this),this.addChild(this.strokeSP)},p.setHide1=function(t){this.ifHide=!1},p.setHide2=function(t){this.ifHide=!0},p.createBG=function(){this.graphics.beginFill(this.colArr[this.type]),this.graphics.drawCircle(0,0,40),this.graphics.endFill()},p.gameOver=function(t){this.touchEnabled=!1},e}(egret.Sprite);egret.registerClass(BlockUI,"BlockUI");var LifeBar=function(t){function e(){t.call(this),this.init()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.init=function(){this.refreshMC=new egret.Sprite,this.refreshMC.x=300,this.refreshMC.addChild(Tools.createBitmapByName("refresh")),this.addChild(this.refreshMC),this.refreshMC.touchEnabled=!0,this.refreshMC.addEventListener(egret.TouchEvent.TOUCH_TAP,this.refreshFun,this),this.createInfoBar(),Tools.getInstance().addEventListener(ToolEvent.GAME_START,this.startEnterFrame,this),Tools.getInstance().addEventListener(ToolEvent.GAME_OVER,this.stopEnterFrame,this)},p.createInfoBar=function(){this.timeTxt=new egret.TextField,this.timeTxt.width=250,this.timeTxt.textColor=0,this.timeTxt.x=48,this.timeTxt.size=40,this.timeTxt.height=60,this.timeTxt.verticalAlign="middle",this.timeTxt.text="30:00",this.addChild(this.timeTxt)},p.startEnterFrame=function(t){this.lastTime=egret.getTimer(),this.addEventListener(egret.Event.ENTER_FRAME,this.checkTime,this)},p.stopEnterFrame=function(t){this.removeEventListener(egret.Event.ENTER_FRAME,this.checkTime,this)},p.checkTime=function(t){var e=egret.getTimer(),i=Math.floor((e-this.lastTime)/100);i>299&&(Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_OVER)),this.removeEventListener(egret.Event.ENTER_FRAME,this.checkTime,this),PopPanel.getInstance().tip("游戏结束，即将跳入结果页!",this.stage)),Tools.getInstance().currentPassTime=Tools.getInstance().totalTime-100*i;var n=Tools.getInstance().currentPassTime,s=Math.floor(n/1e3),r=n%1e3/10,o=0==r?"00":r,a=s>9?s:"0"+s;this.timeTxt.text=a+":"+o},p.refreshFun=function(t){Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_REFRESH))},e}(egret.Sprite);egret.registerClass(LifeBar,"LifeBar");var Line=function(t){function e(e,i,n){t.call(this),this.a=e,this.b=i,this.direct=n}__extends(e,t);var i=(__define,e);return p=i.prototype,e}(egret.Sprite);egret.registerClass(Line,"Line");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e);return p=i.prototype,p.createView=function(){this.textField=new egret.TextField,this.textField.width=480,this.textField.height=100,this.textField.anchorOffsetX=240,this.textField.x=Tools.sw()/2,this.textField.y=300,this.textField.textAlign="center",this.addChild(this.textField)},p.setProgress=function(t,e){this.textField.text="Loading..."+Math.floor(t/e*100)+"%"},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},p.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},p.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),this.createGameScene())},p.createGameScene=function(){var t=new BG;this.addChild(t);var e=new BlockBG;this.addChild(e),e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e.x=this.stage.stageWidth/2,e.y=this.stage.stageHeight/2+100,setTimeout(function(){Tools.getInstance().dispatchEvent(new ToolEvent(ToolEvent.GAME_START))},1e3)},p.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},p.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},p.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var PopPanel=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e);return p=i.prototype,p.init=function(){this.gameoverPanel=new egret.Sprite,this.initBG(),this.initGameoverPanel()},p.initGameoverPanel=function(){this.text=new egret.TextField,this.text.textAlign="left",this.text.width=440,this.text.height=200,this.text.lineSpacing=16,this.text.y=50,this.text.x=Tools.sw()/2-260,this.btn=new egret.Sprite,this.btn.addChild(Tools.createBitmapByName("replay")),this.btn.anchorOffsetX=this.btn.width/2,this.btn.anchorOffsetY=this.btn.height/2,this.btn.y=70,this.btn.touchEnabled=!0,this.btn.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){window.location.href=window.location.href},this),this.gameoverPanel.addChild(this.bg),this.gameoverPanel.addChild(this.text),this.gameoverPanel.addChild(this.btn),this.text.text="游戏结束，数据提交中...";var t=0,e="游戏结束，数据提交中",i=this;setInterval(function(){t++,t%4==0&&(i.text.text=e),t%4==1&&(i.text.text=e+"."),t%4==2&&(i.text.text=e+".."),t%4==3&&(i.text.text=e+"...")},200)},e.getInstance=function(){return null==this.instance&&(this.instance=new e,this.instance.init()),this.instance},p.initBG=function(){this.bg=new egret.Sprite,this.bg.graphics.beginFill(0,.8),this.bg.graphics.drawRect(0,0,Tools.sw(),Tools.sh()),this.bg.graphics.endFill(),this.bg.anchorOffsetX=Tools.sw()/2,this.bg.anchorOffsetY=Tools.sh()/2},p.tip=function(t,e){var i=this;this.text.anchorOffsetX=this.text.width/2,this.text.anchorOffsetY=this.text.height/2,setTimeout(function(){e.addChild(i.gameoverPanel)},500),this.gameoverPanel.x=Tools.sw()/2,this.gameoverPanel.y=Tools.sh()/2},e}(egret.Sprite);egret.registerClass(PopPanel,"PopPanel");var ToolEvent=function(t){function e(e){t.call(this,e)}__extends(e,t);var i=(__define,e);return p=i.prototype,e.GAME_START="gamestart",e.GAME_OVER="gameover",e.GAME_TAB_PATTERN="gametabpattern",e.GAME_REFRESH="gamerefresh",e}(egret.Event);egret.registerClass(ToolEvent,"ToolEvent");var Tools=function(t){function e(){t.call(this),this.totalTime=3e4,this.currentPassTime=0,this.objLen=24}__extends(e,t);var i=(__define,e);return p=i.prototype,e.sw=function(){var t=egret.MainContext.instance.stage.stageWidth,e=egret.MainContext.instance.stage.stageHeight;return t>e?e:t},e.sh=function(){var t=egret.MainContext.instance.stage.stageWidth,e=egret.MainContext.instance.stage.stageHeight;return t>e?t:e},e.getInstance=function(){return null==e.instance&&(e.instance=new e,e.instance.visible=!1),e.instance},e.createMCByName=function(t,e){var i=RES.getRes(e+".json"),n=RES.getRes(e+".png"),s=new egret.MovieClipDataFactory(i,n),r=new egret.MovieClip(s.generateMovieClipData());return console.log(i),r},e.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.createSpriteSheetByName=function(t){var e=RES.getRes(t),i=new egret.SpriteSheet(e);return i},e.getBitmapFromSheet=function(t,e){var i=RES.getRes(t+"."+e),n=new egret.Bitmap(i);return n},e.getBitmapFont=function(t){var e=RES.getRes(t),i=new egret.BitmapText;return i.font=e,i},e.sendURL=function(t,e){var i=new egret.URLLoader;i.dataFormat=egret.URLLoaderDataFormat.TEXT,i.addEventListener(egret.Event.COMPLETE,function(t){console.log("向服务器数据请求成功,数据为:"+i.data),e(),this.theFastCar=i.data},this),i.load(new egret.URLRequest(t))},p.tip=function(){e.getInstance().visible=!e.getInstance().visible,e.getInstance().bg||(e.getInstance().bg=new egret.Sprite,e.getInstance().bg.graphics.beginFill(0,.7),e.getInstance().bg.graphics.drawRect(0,0,e.sw(),e.sh()),e.getInstance().bg.graphics.endFill(),e.getInstance().addChild(e.getInstance().bg))},p.tipWin=function(){e.getInstance().visible=!e.getInstance().visible},p.initObjOffset=function(t){t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2},e}(egret.Sprite);egret.registerClass(Tools,"Tools");